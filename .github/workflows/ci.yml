name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  lint-and-format:
    name: ğŸ§¹ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” Check File Structure  
      run: |
        echo "Checking project structure..."
        test -f CMakeLists.txt || (echo "âŒ CMakeLists.txt missing" && exit 1)
        test -f README.md || (echo "âŒ README.md missing" && exit 1)
        test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
        test -d src/ || (echo "âŒ src/ directory missing" && exit 1)
        test -f src/main.cpp || (echo "âŒ src/main.cpp missing" && exit 1)
        echo "âœ… Project structure OK"

    - name: ğŸ“ Check Code Style
      run: |
        echo "Checking basic code style..."
        # Check for tabs (should use spaces)
        if grep -r $'\t' src/ --include="*.cpp" --include="*.h"; then
          echo "âŒ Found tabs in source files (use 4 spaces instead)"
          exit 1
        fi
        echo "âœ… No tabs found"
        
        # Check line endings (should be LF)
        if find src/ -name "*.cpp" -o -name "*.h" | xargs file | grep -q CRLF; then
          echo "âŒ Found CRLF line endings (use LF)"
          exit 1
        fi  
        echo "âœ… Line endings OK"

  build-matrix:
    name: ğŸ”¨ Build & Test
    needs: lint-and-format
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux with different compilers
          - os: ubuntu-latest
            compiler: gcc
            cpp_compiler: g++
            name: "Ubuntu GCC"
            install_deps: sudo apt-get update && sudo apt-get install -y libsfml-dev
            
          - os: ubuntu-latest  
            compiler: clang
            cpp_compiler: clang++
            name: "Ubuntu Clang"
            install_deps: sudo apt-get update && sudo apt-get install -y libsfml-dev clang
            
          # Windows
          - os: windows-latest
            compiler: msvc
            cpp_compiler: cl
            name: "Windows MSVC"
            install_deps: vcpkg install sfml:x64-windows
            
          # macOS
          - os: macos-latest
            compiler: clang  
            cpp_compiler: clang++
            name: "macOS Clang"
            install_deps: brew install sfml

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup Build Tools
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
      run: |
        sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
        sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100

    - name: ğŸ“¦ Install Dependencies
      run: ${{ matrix.install_deps }}

    - name: ğŸ—ï¸ Configure CMake (with SFML)
      run: |
        mkdir build-gui && cd build-gui
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          ${{ matrix.os == 'windows-latest' && '-A x64 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake' || '' }}

    - name: ğŸ”¨ Build with GUI Support
      run: |
        cd build-gui
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel

    - name: âœ… Test GUI Build
      run: |
        cd build-gui
        echo "Testing GUI-enabled build..."
        echo "3" | ./${{ matrix.os == 'windows-latest' && 'Release/' || '' }}snake-game${{ matrix.os == 'windows-latest' && '.exe' || '' }} || echo "GUI test completed"

    - name: ğŸ—ï¸ Configure CMake (CLI only)  
      run: |
        # Temporarily hide SFML to test CLI-only build
        mkdir build-cli && cd build-cli
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: ğŸ”¨ Build CLI Only
      run: |
        cd build-cli  
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel

    - name: âœ… Test CLI Build
      run: |
        cd build-cli
        echo "Testing CLI-only build..."
        echo "3" | ./${{ matrix.os == 'windows-latest' && 'Release/' || '' }}snake-game${{ matrix.os == 'windows-latest' && '.exe' || '' }} || echo "CLI test completed"

    - name: ğŸ“Š Build Summary
      run: |
        echo "âœ… Build Summary for ${{ matrix.name }}:"
        echo "  - GUI build: $(ls -la build-gui/${{ matrix.os == 'windows-latest' && 'Release/' || '' }}snake-game${{ matrix.os == 'windows-latest' && '.exe' || '' }} | awk '{print $5}') bytes"
        echo "  - CLI build: $(ls -la build-cli/${{ matrix.os == 'windows-latest' && 'Release/' || '' }}snake-game${{ matrix.os == 'windows-latest' && '.exe' || '' }} | awk '{print $5}') bytes"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-matrix
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        
    - name: ğŸ—ï¸ Build for Analysis
      run: |
        sudo apt-get update && sudo apt-get install -y libsfml-dev
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Debug
        make -j$(nproc)
        
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“– Validate README
      run: |
        echo "Checking README completeness..."
        
        # Check for required sections
        sections=("Features" "Quick Start" "Building" "Architecture" "Contributing" "License")
        for section in "${sections[@]}"; do
          if ! grep -q "## .*$section" README.md; then
            echo "âŒ Missing section: $section"
            exit 1
          fi
        done
        echo "âœ… README sections complete"
        
        # Check for broken links (basic check)
        if grep -o 'http[s]*://[^)]*' README.md | head -5 | while read url; do
          if ! curl -s --head "$url" | head -1 | grep -q "200 OK"; then
            echo "âš ï¸  Potentially broken link: $url"
          fi
        done; then
          echo "âœ… External links checked"
        fi

    - name: ğŸ“„ Validate LICENSE
      run: |
        echo "Checking LICENSE file..."
        test -f LICENSE || (echo "âŒ LICENSE file missing" && exit 1)
        grep -q "MIT License" LICENSE || (echo "âŒ Not MIT License" && exit 1)
        grep -q "$(date +%Y)" LICENSE || echo "âš ï¸  License year might be outdated"
        echo "âœ… LICENSE file OK"

  deployment-test:
    name: ğŸš€ Deployment Test
    runs-on: ubuntu-latest
    needs: [build-matrix, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Build Release Package
      run: |
        sudo apt-get update && sudo apt-get install -y libsfml-dev
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
        
        # Create release package
        tar -czf snake-game-test.tar.gz snake-game README.md LICENSE BUILD.md
        echo "âœ… Release package created: $(ls -la snake-game-test.tar.gz | awk '{print $5}') bytes"
        
    - name: ğŸ“¤ Upload Test Artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-release-package
        path: build/snake-game-test.tar.gz
        retention-days: 7

  status-summary:
    name: ğŸ“‹ Build Status
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-matrix, security-scan, documentation, deployment-test]
    if: always()
    
    steps:
    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸ¯ CI/CD Pipeline Summary"
        echo "| Job | Status |"
        echo "|-----|--------|"  
        echo "| Code Quality | ${{ needs.lint-and-format.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
        echo "| Build & Test | ${{ needs.build-matrix.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
        echo "| Security | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
        echo "| Documentation | ${{ needs.documentation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
        echo "| Deployment Test | ${{ needs.deployment-test.result == 'success' && 'âœ… Passed' || needs.deployment-test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |"
        
        if [[ "${{ needs.lint-and-format.result }}" == "success" && 
              "${{ needs.build-matrix.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.documentation.result }}" == "success" ]]; then
          echo "ğŸ‰ All checks passed! Ready for release."
        else
          echo "âš ï¸ Some checks failed. Please review before merging."
        fi